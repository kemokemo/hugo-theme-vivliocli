<!DOCTYPE html>
<!-- cover & toc -->

{{- $title := partial "functions/outputEditionParam" (dict "page" . "param" "doctitle" ) }}
{{- $subtitle := partial "functions/outputEditionParam" (dict "page" . "param" "subtitle" ) }}
{{- $doc_number := partial "functions/outputEditionParam" (dict "page" . "param" "doc_number" ) }}

<html lang="{{ .Page.Language | default "en" }}">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{{ $title }}</title>
  <!-- css -->
  {{- range .Site.Params.theme_css -}}
  <link rel="stylesheet" href="{{ . | relURL }}">
  {{- end -}}
</head>

<body>
  <div id="cover" role="doc-cover">
    <div id="cover-title">
      {{- if $doc_number }}<h2>{{ $doc_number}}</h2>{{- end }}
      <h1>{{ $title }}</h1>
      {{- if $subtitle }}<h2>{{ $subtitle }}</h2>{{- end }}
    </div>
    {{- if .Params.author }}<div id="cover-author"><h2>{{ .Params.author }}</h2></div>{{- end }}
    {{- if .Params.company }}<h3>{{ .Params.company }}</h3>{{- end }}
  </div>
  {{/*  introduction  */}}
  {{- if .Page.Content }}
  <div role="doc-introduction">
  {{ .Page.Content }}
  </div>
  {{- end }}


{{/*  Table of Contents  */}}
{{ $toc := .Params.toc | default true }}
{{- if eq $toc true }}
<nav id="toc" role="doc-toc">
<h2>Table of Contents</h2>
{{ template "section_hierarchy" .CurrentSection }}
</nav>
{{- end }}
</body>
</html>


{{/*  Table of Contents hierarchy  */}}
{{- define "section_hierarchy" }}
{{- $sectionPageCount := len .Pages }}
{{- if ne $sectionPageCount 0 -}}
<ol>
  {{- range .Pages.ByWeight }}
  {{- if partial "functions/isShow" . }}
  <li>
    {{/* 日本語文字化け対策： https://discourse.gohugo.io/t/how-decode-urls-in-hugo/7549 */}}
    {{- $url := urls.Parse (.RelPermalink | urlize) }}
    {{- $a := printf "..%s" $url.Path }}
    {{- if ne .IsSection true }}
      {{/* https://nasust.com/hugo/a1fe8f73-9e3f-4fa3-89c2-a5de90806121 */}}
      {{- $sectionNo := partial "functions/getSectionNo" . }}
      {{- $sectionNoRaw := partial "functions/getSectionNoRaw" . }}
      <a {{ printf "href=%q" $a | safeHTMLAttr }}>{{ $sectionNo }} {{ .Title }}</a>
      {{- template "pagetoc" (dict "sectionNo" $sectionNoRaw "page" .Page ) }}
    {{- end }}
    {{- if .IsSection }}
      <a {{ printf "href=%q" $a | safeHTMLAttr }} {{- if .Params.role }} class="{{ .Params.role }}" {{- end }}>{{ partial "functions/getSectionNo" . }} {{ .Title }}</a>
      {{/*  section は pdftoc に非対応  */}}
    {{- template "section_hierarchy" . }}
    {{- end -}}
  </li>
  {{- end }}
  {{- end }}
</ol>
{{- end }}
{{- end }}

{{/* "pdftoc" classを含むヘッダからPDF目次を生成  */}}
{{- define "pagetoc" }}
{{- $page := .page }}
{{- $sectionNo := .sectionNo }}
{{- $url := urls.Parse ($page.RelPermalink | urlize) }}
{{- $a := printf "..%s#" $url.Path }}
{{- $pagelink := newScratch }}
{{- $pagelink.Set "link" $a }}
{{- $content := partial "content-with-section.html" (dict "sectionNo" $sectionNo "page" $page ) }}
{{- $toc := (partial "page-toc.html" $content) | replaceRE "<nav id=.+?>" "" | replaceRE "</nav>" "" | safeHTML }}
{{- $toc = $toc | replaceRE "<ul>" "<ol>" | replaceRE "</ul>" "</ol>" | safeHTML}}
{{- $toc = $toc | replaceRE `(\")#(.*?\".*?class=\"pdftoc\")` (printf "${1}%s${2}" ($pagelink.Get "link")) | safeHTML}}
{{/*  {{ partial "log" $toc }}  */}}
{{/* #pdftoc-xxx以外のヘッダ行を削除し、不要なolタグを消す  */}}
{{- $toc = $toc | replaceRE "<a href=.#.*?>(?:.|\n)*?</a>" "" | safeHTML}}
{{- range $val := seq 6 }}
{{- $toc = $toc | replaceRE "(?m)(?s:<li>[[:space:]]*</li>)" "" | safeHTML }}
{{- $toc = $toc | replaceRE "(?m)(?s:<ol>[[:space:]]*</ol>)" "" | safeHTML }}
{{- end }}
{{ $toc }}
{{- end }}
